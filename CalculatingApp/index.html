<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사칙연산 암산 연습</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4b6cb7">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f7; color: #222; }
    header { background: #4b6cb7; color: #fff; padding: 16px 20px; }
    main { padding: 20px; max-width: 960px; margin: 0 auto; }
    section { background: #fff; padding: 16px; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    h2 { margin: 0 0 12px; }
    label { display: block; margin: 6px 0; }
    input[type="number"] { width: 80px; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .problem { font-size: 32px; font-weight: 700; text-align: center; padding: 16px 0; }
    .status { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .btn { background: #4b6cb7; color: #fff; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .input-area { text-align: center; }
    .input-area input { font-size: 24px; padding: 8px; width: 140px; text-align: center; }
    .leaderboard-table { width: 100%; border-collapse: collapse; }
    .leaderboard-table th, .leaderboard-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .table-wrap { overflow-x: auto; }
    .table-wrap table { min-width: 640px; }
    .notice { color: #666; font-size: 14px; }
    body.session-mode header { display: none; }
    body.session-mode main { padding-top: 12px; }
    @media (max-width: 640px) {
      main { padding: 12px; }
      section { padding: 14px; }
      .row { flex-direction: column; align-items: flex-start; }
      .status { flex-direction: column; gap: 6px; }
      .problem { font-size: 28px; }
      .input-area { display: flex; flex-direction: column; gap: 8px; align-items: center; }
      .input-area input { width: 100%; max-width: 320px; }
      .btn { width: 100%; max-width: 240px; text-align: center; }
      select, input[type="number"] { width: 100%; max-width: 240px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>사칙연산 암산 연습</h1>
  </header>
  <main>
    <section id="setup">
      <h2>세션 설정</h2>
      <div class="row">
        <div>
          <label>문항 수</label>
          <select id="problemCount">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="40">40</option>
          </select>
        </div>
        <div>
          <label>자릿수</label>
          <select id="digitLength">
            <option value="1">1자리</option>
            <option value="2">2자리</option>
            <option value="3">3자리</option>
            <option value="4">4자리</option>
          </select>
        </div>
        <div>
          <label>연산 선택(1개만)</label>
          <label><input type="radio" name="opSelect" class="op" value="+" checked> 덧셈</label>
          <label><input type="radio" name="opSelect" class="op" value="-"> 뺄셈</label>
          <label><input type="radio" name="opSelect" class="op" value="*"> 곱셈</label>
        </div>
      </div>
      <div style="margin-top:12px;">
        <button class="btn" id="startBtn">연습 시작</button>
      </div>
      <p class="notice">정답 시 자동으로 다음 문제로 이동합니다.</p>
    </section>

    <section id="session" style="display:none;">
      <div class="status">
        <div>진행: <span id="progress">0/0</span></div>
        <div>타이머: <span id="timer">00:00.000</span></div>
      </div>
      <div class="problem" id="problemText">문제를 불러오는 중...</div>
      <div class="input-area">
        <input type="number" id="answerInput" placeholder="정답 입력" inputmode="numeric" pattern="[0-9]*" />
        <button class="btn" id="stopBtn">종료</button>
      </div>
    </section>

    <section id="result" style="display:none;">
      <h2>결과</h2>
      <div>총 소요 시간: <strong id="totalTime">00:00.000</strong></div>
      <div>평균 문제당 시간: <strong id="avgTime">0 ms</strong></div>
      <div>풀이한 문제 수: <strong id="solvedCount">0</strong></div>
      <div style="margin-top:10px;">
        <button class="btn" id="restartBtn">다시 풀기</button>
        <button class="btn" id="resultHomeBtn">설정/리더보드로</button>
      </div>
    </section>

    <section id="leaderboard">
      <h2>리더보드</h2>
      <div class="row">
        <div>
          <label>자릿수 필터</label>
          <select id="lbDigit">
            <option value="1">1자리</option>
            <option value="2">2자리</option>
            <option value="3">3자리</option>
            <option value="4">4자리</option>
          </select>
        </div>
        <div>
          <label>연산 필터</label>
          <select id="lbOp">
            <option value="+">덧셈</option>
            <option value="-">뺄셈</option>
            <option value="*">곱셈</option>
          </select>
        </div>
        <div>
          <label>날짜 필터 (일 단위)</label>
          <input type="date" id="lbDate" />
        </div>
        <button class="btn" id="lbRefreshBtn">새로고침</button>
        <button class="btn" id="lbResetBtn" style="background:#b74b4b;">리더보드 초기화</button>
      </div>
      <p class="notice">동일 자릿수 + 연산 조합별 최고 기록을 표시합니다.</p>
      <p class="notice" id="lbStats"></p>
      <p class="notice" id="lbBest"></p>
      <div class="table-wrap">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>자릿수</th><th>연산</th><th>문항 수</th><th>총 소요 시간</th><th>평균/문항(초)</th><th>날짜/시간</th><th>비고</th>
            </tr>
          </thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div>
    </section>

    <section id="leaderboard-best">
      <h2>최고 기록 (자릿수+연산별 평균/문항 최단)</h2>
      <p class="notice">모든 기록을 기준으로 자릿수+연산 조합별 평균 문제당 시간이 가장 짧은 기록을 보여줍니다.</p>
      <div class="table-wrap">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>자릿수</th><th>연산</th><th>문항 수</th><th>총 소요 시간</th><th>평균/문항(초)</th><th>날짜/시간</th>
            </tr>
          </thead>
          <tbody id="lbBestBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // 세션 상태
    let settings = { problemCount: 10, digitLength: 1, operations: [] };
    const MAX_RECORDS = 9999;
    let problems = [];
    let currentIdx = 0;
    let startTime = 0;
    let timerId = null;
    let elapsedMs = 0;
    function resetPauseState() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      els.answerInput.disabled = false;
    }

    const els = {
      problemCount: document.getElementById('problemCount'),
      digitLength: document.getElementById('digitLength'),
      opChecks: Array.from(document.querySelectorAll('.op')),
      startBtn: document.getElementById('startBtn'),
      setup: document.getElementById('setup'),
      session: document.getElementById('session'),
      progress: document.getElementById('progress'),
      timer: document.getElementById('timer'),
      problemText: document.getElementById('problemText'),
      answerInput: document.getElementById('answerInput'),
      stopBtn: document.getElementById('stopBtn'),
      result: document.getElementById('result'),
      totalTime: document.getElementById('totalTime'),
      avgTime: document.getElementById('avgTime'),
      solvedCount: document.getElementById('solvedCount'),
      restartBtn: document.getElementById('restartBtn'),
      resultHomeBtn: document.getElementById('resultHomeBtn'),
      leaderboard: document.getElementById('leaderboard'),
      lbDigit: document.getElementById('lbDigit'),
      lbOp: document.getElementById('lbOp'),
      lbDate: document.getElementById('lbDate'),
      lbRefreshBtn: document.getElementById('lbRefreshBtn'),
      lbResetBtn: document.getElementById('lbResetBtn'),
      lbStats: document.getElementById('lbStats'),
      lbBest: document.getElementById('lbBest'),
      lbBody: document.getElementById('lbBody'),
      lbBestBody: document.getElementById('lbBestBody'),
      lbBestSection: document.getElementById('leaderboard-best'),
    };

    function toDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function formatMs(ms) {
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      const mm = (ms % 1000).toString().padStart(3, '0');
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}.${mm}`;
    }

    function updateTimer() {
      const now = Date.now();
      elapsedMs = now - startTime;
      els.timer.textContent = formatMs(elapsedMs);
    }

    function startTimer() {
      startTime = Date.now();
      timerId = setInterval(updateTimer, 50);
    }

    function stopTimer() {
      clearInterval(timerId);
      timerId = null;
      updateTimer();
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateProblem(digitLength, op) {
      const min = digitLength === 1 ? 0 : Math.pow(10, digitLength - 1);
      const max = Math.pow(10, digitLength) - 1;
      let a, b, answer;
      if (op === '+') {
        a = randInt(min, max); b = randInt(min, max); answer = a + b;
      } else if (op === '-') {
        a = randInt(min, max); b = randInt(min, max);
        if (b > a) [a, b] = [b, a];
        answer = a - b;
      } else if (op === '*') {
        a = randInt(min, max); b = randInt(min, max); answer = a * b;
      }
      return { a, b, op, answer };
    }

    function buildProblems() {
      problems = [];
      for (let i = 0; i < settings.problemCount; i++) {
        const op = settings.operations[randInt(0, settings.operations.length - 1)];
        problems.push(generateProblem(settings.digitLength, op));
      }
    }

    function renderProblem() {
      const p = problems[currentIdx];
      els.problemText.textContent = `${p.a} ${p.op} ${p.b} = ?`;
      els.progress.textContent = `${currentIdx + 1}/${problems.length}`;
      els.answerInput.value = '';
      els.answerInput.focus();
    }

    function finishSession() {
      stopTimer();
      resetPauseState();
      showResultOnly();
      const total = elapsedMs;
      const avg = Math.round(total / problems.length);
      els.totalTime.textContent = formatMs(total);
      els.avgTime.textContent = `${avg} ms`;
      els.solvedCount.textContent = `${problems.length}`;
      saveRecord(total);
    }

    function handleAnswer() {
      const raw = els.answerInput.value;
      if (raw.trim() === '') return; // 공백/빈 입력은 무시
      const val = Number(raw);
      const p = problems[currentIdx];
      if (Number.isNaN(val)) return;
      if (val === p.answer) {
        currentIdx += 1;
        if (currentIdx >= problems.length) {
          finishSession();
        } else {
          renderProblem();
        }
      }
    }

    function stopSession() {
      resetPauseState();
      showHome(false);
    }

    function startSession() {
      resetPauseState();
      currentIdx = 0;
      settings.problemCount = Number(els.problemCount.value);
      settings.digitLength = Number(els.digitLength.value);
      const selectedOp = els.opChecks.find(c => c.checked)?.value;
      if (!selectedOp) {
        alert('연산을 하나 선택하세요.');
        return;
      }
      settings.operations = [selectedOp];
      buildProblems();
      showSessionOnly();
      renderProblem();
      startTimer();
    }

    function getSettingsKey(digit, ops) {
      return `${digit}-${ops.sort().join('')}`;
    }

    function loadRecords() {
      const raw = localStorage.getItem('mental-math-records');
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.warn('기록 파싱 오류로 초기화합니다.', e);
        saveRecords([]);
        return [];
      }
    }

    function saveRecords(list) {
      localStorage.setItem('mental-math-records', JSON.stringify(list));
    }

    function saveRecord(durationMs) {
      const records = loadRecords();
      const avgMs = durationMs / settings.problemCount;
      const entry = {
        digit: settings.digitLength,
        ops: settings.operations.slice().sort(),
        problemCount: settings.problemCount,
        durationMs,
        avgMs,
        date: new Date().toISOString(),
      };
      records.push(entry);
      while (records.length > MAX_RECORDS) {
        records.shift(); // 오래된 것부터 삭제
      }
      saveRecords(records);
    }

    function renderLeaderboard() {
      const digit = Number(els.lbDigit.value);
      const op = els.lbOp.value;
      const dateFilter = els.lbDate.value; // yyyy-mm-dd or ''
      const allRecords = loadRecords();
      els.lbStats.textContent = `저장: ${allRecords.length} / ${MAX_RECORDS}`;
      const records = allRecords.filter(r => {
        if (!(r.digit === digit && r.ops.length === 1 && r.ops[0] === op)) return false;
        if (!dateFilter) return true;
        const recDate = new Date(r.date);
        return toDateKey(recDate) === dateFilter;
      });
      // 평균 문제당 시간 기준 정렬 (기록에 avgMs 없으면 총 시간/문항수 또는 총 시간으로 대체)
      const getAvg = (r) => {
        if (typeof r.avgMs === 'number') return r.avgMs;
        if (r.problemCount) return r.durationMs / r.problemCount;
        return r.durationMs;
      };
      const sorted = records.sort((a, b) => getAvg(a) - getAvg(b));
      els.lbBody.innerHTML = '';
      if (sorted.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.textContent = '기록이 없습니다.';
        tr.appendChild(td);
        els.lbBody.appendChild(tr);
        els.lbBest.textContent = '현재 필터에 해당하는 기록이 없습니다.';
        return;
      }
      const bestAvg = getAvg(sorted[0]);
      const best = sorted[0];
      els.lbBest.textContent = `최고 기록: ${best.digit}자리 ${best.ops[0]} | 문항 ${best.problemCount ?? '-'}개 | 총 ${formatMs(best.durationMs)} | 평균 ${(bestAvg/1000).toFixed(3)}초 | 날짜 ${new Date(best.date).toLocaleString()}`;
      sorted.slice(0, 20).forEach(rec => {
        const avgMs = getAvg(rec);
        const tr = document.createElement('tr');

        const cells = [
          `${rec.digit}자리`,
          `${rec.ops[0]}`,
          `${rec.problemCount ?? '-'}`,
          `${formatMs(rec.durationMs)}`,
          `${(avgMs / 1000).toFixed(3)} 초`,
          `${new Date(rec.date).toLocaleString()}`,
          `${avgMs === bestAvg ? '최고 기록' : ''}`
        ];

        cells.forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });

        els.lbBody.appendChild(tr);
      });
    }

    function renderLeaderboardBestOverall() {
      const allRecords = loadRecords();
      const grouped = new Map(); // key: digit-op, val: record with best avg
      const getAvg = (r) => {
        if (typeof r.avgMs === 'number') return r.avgMs;
        if (r.problemCount) return r.durationMs / r.problemCount;
        return r.durationMs;
      };
      allRecords.forEach(r => {
        if (!(r.ops && r.ops.length === 1)) return;
        const key = `${r.digit}-${r.ops[0]}`;
        const avg = getAvg(r);
        const current = grouped.get(key);
        if (!current || avg < getAvg(current)) grouped.set(key, r);
      });
      const bestList = Array.from(grouped.values()).sort((a, b) => {
        if (a.digit !== b.digit) return a.digit - b.digit;
        return a.ops[0].localeCompare(b.ops[0]);
      });
      els.lbBestBody.innerHTML = '';
      if (bestList.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.textContent = '기록이 없습니다.';
        tr.appendChild(td);
        els.lbBestBody.appendChild(tr);
        return;
      }
      bestList.forEach(rec => {
        const avgMs = getAvg(rec);
        const tr = document.createElement('tr');
        [
          `${rec.digit}자리`,
          `${rec.ops[0]}`,
          `${rec.problemCount ?? '-'}`,
          `${formatMs(rec.durationMs)}`,
          `${(avgMs / 1000).toFixed(3)} 초`,
          `${new Date(rec.date).toLocaleString()}`
        ].forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });
        els.lbBestBody.appendChild(tr);
      });
    }

    function resetLeaderboard() {
      if (!confirm('리더보드 기록을 모두 삭제할까요?')) return;
      saveRecords([]);
      renderLeaderboard();
    }

    // 이벤트 바인딩
    els.startBtn.addEventListener('click', startSession);
    els.answerInput.addEventListener('input', handleAnswer);
    els.stopBtn.addEventListener('click', stopSession);
    els.restartBtn.addEventListener('click', () => {
      showSessionOnly();
      currentIdx = 0;
      buildProblems();
      renderProblem();
      startTimer();
    });
    els.resultHomeBtn.addEventListener('click', () => {
      showHome(false);
    });
    els.lbRefreshBtn.addEventListener('click', () => {
      renderLeaderboard();
      renderLeaderboardBestOverall();
    });
    els.lbResetBtn.addEventListener('click', () => {
      resetLeaderboard();
      renderLeaderboardBestOverall();
    });

    function showSessionOnly() {
      els.setup.style.display = 'none';
      els.leaderboard.style.display = 'none';
      els.lbBestSection.style.display = 'none';
      els.result.style.display = 'none';
      els.session.style.display = 'block';
      document.body.classList.add('session-mode');
    }

    function showResultOnly() {
      els.session.style.display = 'none';
      els.setup.style.display = 'none';
      els.leaderboard.style.display = 'none';
      els.lbBestSection.style.display = 'none';
      els.result.style.display = 'block';
      document.body.classList.remove('session-mode');
    }

    function showHome(withResult) {
      els.session.style.display = 'none';
      els.setup.style.display = 'block';
      els.leaderboard.style.display = 'block';
      els.lbBestSection.style.display = 'block';
      els.result.style.display = withResult ? 'block' : 'none';
      document.body.classList.remove('session-mode');
      if (withResult) renderLeaderboard();
    }

    // PWA: 서비스 워커 등록
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      });
    }

    // 초기 상태
    renderLeaderboard();
    renderLeaderboardBestOverall();
  </script>
</body>
</html>

